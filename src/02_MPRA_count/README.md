# MPRAcount Step — MPRA Replicate Counting Pipeline

### Overview

The MPRAcount step quantifies barcode counts across biological replicates using the barcode–oligo dictionary generated by MPRAmatch.

This stage processes individual replicate FASTQs, matches their barcodes to the reference dictionary, filters and counts valid barcode–oligo associations, and produces formatted tables ready for downstream modeling.

⸻

### Key Steps

1️⃣ Preprocess replicate barcodes
	•	Each replicate FASTQ is scanned to pull barcodes using make_counts.py.
	•	Outputs an intermediate *.match file listing barcodes found per read.

2️⃣ Associate barcodes with oligos
	•	Matches extracted barcodes to the parsed oligo dictionary from MPRAmatch using associate_tags.py.
	•	Outputs a *.tag file per replicate, summarizing mapping status and metrics.

3️⃣ Create input list for compilation
	•	Generates a single summary file listing all replicate .tag files and IDs to drive the count table generation.

4️⃣ Compile barcode count table
	•	Aggregates barcode–oligo pairs into a unified *.count table across replicates.
	•	Produces logs (*.log) and summary statistics (*.stats).

5️⃣ Generate QC metrics
	•	Parses log files to compute barcode-level and read-level mapping rates.
	•	Writes a .stats summary for each replicate.

6️⃣ Condition file creation
	•	Produces a _condition.txt file linking each replicate to its experimental condition, required by MPRAmodel.

7️⃣ Generate cell-type specific tables
	•	Creates raw count files specific to cell types or conditions using bc_raw.py.

⸻

### Key Outputs

File Extension	Description
*.match	Intermediate raw barcode match data per replicate
*.tag	Barcode–oligo association summary per replicate
*.count	Final compiled barcode count table across replicates
*.log	Detailed compilation logs
*.stats	Summary stats per replicate
_condition.txt	Condition metadata table for downstream modeling


⸻

### Detailed Intermediate Files

*.match

Column	Description
1.	Sequence ID
2.	Found barcode sequence
3.	(Matching oligo)


*.tag

Column	Description
1.	Barcode
2.	Total seen
3.	Tag flag: 0 = no issue mapping -9 = not in parsed file -1 = collision accepted -4 = collision not accepted -5 = mapping failed -6 = mapped reverse complement
4.	Oligo ID (from parsed)
5.	Mapping flag (from parsed; - if barcode not in dictionary)
6.	Barcode sequence
7.	Error (from parsed)
8.	CIGAR string (from parsed)
9.	MD/cs tag (from parsed)
10.	Start/stop coordinates (from parsed)



*.stats

Column	Description
1.	Replicate ID
2.	Good barcodes (mapping flag == 0)
3.	Good reads (mapping flag == 0)
4.	Total matched reads (flag in [0,1,2])
5.	Percent good reads / total matched reads
6.	All barcodes (flag in [-,0,1,2])
7.	All reads (flag in [-,0,1,2])
8.	Percent good reads / all reads

_condition.txt

Column	Description
1.	Replicate ID (used as row names in R)
2.	Condition label used by MPRAmodel


⸻
### Summary

The MPRAcount step takes barcode assignments from MPRAmatch, validates them against the reference dictionary, and outputs high-quality, replicate-level barcode count tables ready for differential analysis and modeling.
